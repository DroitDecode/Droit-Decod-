<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Droit Décodé - Articles & Explications</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-primary-red: #E84D3D;
            --color-primary-blue: #3E4B7A;
            --color-secondary-bg: #F8F9FA;
        }
        body { background-color: var(--color-secondary-bg); font-family: 'Inter', sans-serif; }
        .text-primary-red { color: var(--color-primary-red); }
        .bg-primary-red { background-color: var(--color-primary-red); }
        .text-primary-blue { color: var(--color-primary-blue); }
        .border-primary-red { border-color: var(--color-primary-red); }
    </style>
</head>
<body>

    <header role="banner">
        <div class="logo-container">
            <a href="index.html">
                <img src="logo1.jpeg" alt="Logo">
                <div class="logo-text"><strong>DROIT</strong> <span>DÉCODÉ</span></div>
            </a>
        </div>
        <nav role="navigation">
            <ul>
                <li><a href="index.html">Accueil</a></li>
                <li><a href="articles.html" class="active">Articles</a></li>
                <li><a href="tiktok.html">TikTok</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-4xl">
        
        <section id="admin-section" class="hidden mb-12 bg-white p-6 rounded-xl shadow-xl border-t-4 border-primary-red">
            <h2 class="text-2xl font-bold mb-4 text-primary-blue">Publier un nouvel article</h2>
            <form id="article-form" class="space-y-4">
                <input type="hidden" id="article-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Titre de l'article</label>
                    <input type="text" id="title" required class="w-full p-2 border rounded-md outline-none focus:ring-2 focus:ring-red-400">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Lien de l'image (URL)</label>
                    <input type="url" id="image-url" required class="w-full p-2 border rounded-md outline-none focus:ring-2 focus:ring-red-400" placeholder="https://exemple.com/image.jpg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Contenu de l'article</label>
                    <textarea id="content" required rows="6" class="w-full p-2 border rounded-md outline-none focus:ring-2 focus:ring-red-400"></textarea>
                </div>
                <button type="submit" id="submit-btn" class="bg-primary-red text-white px-6 py-2 rounded-md font-bold hover:bg-red-600 transition">Publier l'article</button>
                <button type="button" id="cancel-edit" class="hidden ml-2 text-gray-500 underline">Annuler modification</button>
            </form>
        </section>

        <h1 class="text-3xl font-extrabold text-primary-blue mb-8 border-b-4 pb-2 border-primary-red">Dernières Publications</h1>

        <div id="articles-container" class="space-y-8">
            <p class="text-center text-gray-500">Chargement des articles...</p>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDpNtHXiZK3bIyLwAUlTNAiWRrg2vhPYeE",
            authDomain: "droitdecode-9aa4d.firebaseapp.com",
            projectId: "droitdecode-9aa4d",
            storageBucket: "droitdecode-9aa4d.firebasestorage.app",
            messagingSenderId: "219930978240",
            appId: "1:219930978240:web:886c40e47d276c75548a25"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ADMIN_UID = "v4086Cxmi9PMI31GUBZzY8rHyIA3"; 

        const adminSection = document.getElementById('admin-section');
        const articleForm = document.getElementById('article-form');
        const articlesContainer = document.getElementById('articles-container');

        // 1. Vérifier si l'utilisateur est l'admin
        onAuthStateChanged(auth, (user) => {
            if (user && user.uid === ADMIN_UID) {
                adminSection.classList.remove('hidden');
            } else {
                adminSection.classList.add('hidden');
            }
            loadArticles(user && user.uid === ADMIN_UID);
        });

        // 2. Publier ou Modifier un article
        articleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('article-id').value;
            const data = {
                title: document.getElementById('title').value,
                imageUrl: document.getElementById('image-url').value,
                content: document.getElementById('content').value,
                timestamp: serverTimestamp()
            };

            try {
                if (id) {
                    await updateDoc(doc(db, "Articles", id), data);
                    alert("Article modifié !");
                } else {
                    await addDoc(collection(db, "Articles"), data);
                    alert("Article publié !");
                }
                articleForm.reset();
                resetForm();
            } catch (err) { alert("Erreur : " + err.message); }
        });

        // 3. Charger les articles en temps réel
        function loadArticles(isAdmin) {
            const q = query(collection(db, "Articles"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                articlesContainer.innerHTML = '';
                if (snapshot.empty) {
                    articlesContainer.innerHTML = '<p class="text-center text-gray-500">Aucun article pour le moment.</p>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const art = doc.data();
                    const card = document.createElement('div');
                    card.className = "bg-white rounded-xl shadow-lg overflow-hidden border-l-4 border-primary-blue";
                    
                    card.innerHTML = `
                        <img src="${art.imageUrl}" class="w-full h-48 object-cover" onerror="this.src='https://placehold.co/600x400?text=Image+indisponible'">
                        <div class="p-6">
                            <h2 class="text-2xl font-bold text-primary-blue mb-2">${art.title}</h2>
                            <p class="text-xs text-gray-400 mb-4">Publié le ${art.timestamp?.toDate().toLocaleDateString('fr-FR') || 'récemment'}</p>
                            
                            <div class="article-body">
                                <p class="text-gray-700 line-clamp-3 mb-4" id="text-${doc.id}">${art.content}</p>
                                <button onclick="window.toggleText('${doc.id}')" id="btn-${doc.id}" class="text-primary-red font-bold hover:underline">Lire la suite</button>
                            </div>

                            ${isAdmin ? `
                                <div class="mt-6 pt-4 border-t flex space-x-4">
                                    <button onclick="window.editArticle('${doc.id}', '${art.title.replace(/'/g, "\\'")}', '${art.imageUrl}', '${art.content.replace(/'/g, "\\'")}')" class="text-blue-600 text-sm font-bold">Modifier</button>
                                    <button onclick="window.deleteArticle('${doc.id}')" class="text-red-600 text-sm font-bold">Supprimer</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    articlesContainer.appendChild(card);
                });
            });
        }

        // Fonctions globales pour les boutons (Modifier / Supprimer / Lire la suite)
        window.toggleText = (id) => {
            const p = document.getElementById(`text-${id}`);
            const btn = document.getElementById(`btn-${id}`);
            if (p.classList.contains('line-clamp-3')) {
                p.classList.remove('line-clamp-3');
                btn.textContent = "Réduire";
            } else {
                p.classList.add('line-clamp-3');
                btn.textContent = "Lire la suite";
            }
        };

        window.deleteArticle = async (id) => {
            if (confirm("Supprimer cet article ?")) {
                await deleteDoc(doc(db, "Articles", id));
            }
        };

        window.editArticle = (id, title, img, content) => {
            document.getElementById('article-id').value = id;
            document.getElementById('title').value = title;
            document.getElementById('image-url').value = img;
            document.getElementById('content').value = content;
            document.getElementById('submit-btn').textContent = "Enregistrer les modifications";
            document.getElementById('cancel-edit').classList.remove('hidden');
            window.scrollTo(0, 0);
        };

        function resetForm() {
            document.getElementById('article-id').value = "";
            document.getElementById('submit-btn').textContent = "Publier l'article";
            document.getElementById('cancel-edit').classList.add('hidden');
        }

        document.getElementById('cancel-edit').addEventListener('click', () => {
            articleForm.reset();
            resetForm();
        });

    </script>
</body>
</html>
